# BD2Anusorn18

โปรแกรมเก็บข้อมูลศึกษาต่ออนุสรณ์รุ่น 18 โรงเรียนบดินทรเดชา (สิงห์ สิงหเสนี) ๒

## ตั้งค่า

### engine/config.php
1. คัดลอก engine/config.php.def มาที่ engine/config.php
2. ตั้ง `SITE_KEY` เป็น string ใดๆ ควรมีความยาวมาก ยากต่อการคาดเดา (ไม่ใช่รหัสผ่าน ไม่ต้องจำ ใช้ในการเข้ารหัสรหัสผ่าน)
3. ตั้ง `YEAR` เป็นเลขรุ่น เช่น รุ่น 18 ใส่ 18 (integer)
4. ตั้ง `$MONGO` เป็น connection string เช่น `$MONGO = new MongoClient("mongodb://user:pass@host/database");`
5. ตั้ง `$DB` เป็น DB เดียวกับใน connection string เช่น `$DB = $MONGO->database;`
6. ตั้ง `$PASSWORD` เป็นรหัสผ่าน เช่น `$PASSWORD = 'password';`

### resources/templates/base.html
1. บรรทัด 52 แก้ไขชื่อโรงเรียน เลขรุ่นจะอัปเดตตามไฟล์ config.php อัตโนมัติ
2. ลบบรรทัดที่ 28 ถ้าไม่ต้องการใช้มอดูลเก็บข้อมูลที่อยู่

### resources/templates/register/class.html
1. แก้ 14 ใน `{if $class != 14}` เป็นเลขห้องสูงสุด เช่น 14 คือมี 14 ห้อง

### resources/templates/register/index.html
1. แก้ไข 14 ใน `{foreach range(1, 14) as $cls}` เป็นเลขห้องสูงสุด เช่น 14 คือมี 14 ห้อง
2. ควรจัดหน้าใหม่ให้สวยงาม

## เตรียมไฟล์ data.csv
- บรรทัดแรกเป็นหัวตารางโปรแกรมไม่สนใจ
- บรรทัดต่อๆ ไปเป็นรูปแบบดังนี้

`6,1,1,12345,นาย,สมชาย,นามสมมุติ,03072555,1111111111113,ชาย`

**แปลความหมายจากซ้ายไปขวาได้ดังนี้**

- 6,1: ม. 6/1
- 1: เลขที่ 1
- 12345: เลขประจำตัวนักเรียน 12345
- นาย,สมชาย,นามสมมุติ: คำนำหน้าชื่อ,ชื่อ,สกุล ตามลำดับ (โปรแกรมไม่รองรับ "ด.ช.")
- 03072555: เกิดวันที่ 3 กรกฎาคม 2555
- 1111111111113: เลขประจำตัวประชาชน 1111111111113 (โปรแกรมจะอ่านแค่ 4 หลักหลัง)
- ชาย: ชื่อเล่น

## Install
Server ต้องมี Mongo extension สำหรับ PHP และเปิด mod_rewrite

1. Upload ไปที่ root folder ของ domain ใดๆ (ลงใน folder ไม่ได้!) เช่น
   - OK: `http://anusorn.bd2.in.th`
   - NO: `http://bd2.in.th/anusorn` \ 
   สมมุติว่า ติดตั้งไว้ที่ http://localhost/
2. ตั้งให้ web server เขียน folder resources/cached/ resources/compiled/ ได้ (ถ้าไม่มีให้สร้างขึ้นใหม่)
3. Login ให้เข้าไปที่ 
   `http://localhost/register/@auth?auth=password`
   จะปรากฎข้อความ Login OK! (ต้องใส่เป็นรหัสผ่านที่ตั้งไว้)
4. Load ข้อมูลคณะ
   `http://localhost/register/@importfac`
   จะอ่านไฟล์ faculty.json ลงฐานข้อมูล
5. Load ข้อมูลนักเรียน
   `http://localhost/register/@import`
   จะอ่านไฟล์ data.csv ลงฐานข้อมูล

## Address module

โปรแกรมอนุสรณ์รุ่นมีมอดูลสำหรับเก็บข้อมูลที่อยู่จากรายชื่อนักเรียนที่อยู่ในระบบอนุสรณ์

### เปิดใช้งาน
1. แก้ไข index.php ยกเลิก comment บรรทัดที่ 56-57
2. แก้ไข index.php แก้ไขบรรทัดที่ 55 เป็น `"address"              => array("address.class.php", array("Address", "login")),`

### สถิติการกรอกข้อมูล
สามารถดูสถิติการกรอกข้อมูลได้ที่ `http://localhost/address/stat`

### รับข้อมูลม. 3
กรณีที่ต้องการให้นักเรียนชั้นอื่นกรอกข้อมูลด้วย สามารถนำเข้าข้อมูลได้ด้วยไฟล์ new.csv

รูปแบบไฟล์ new.csv: `เลขที่ เลขประจำตัว คำนำหน้า ชื่อ สกุล ชั้น` (คั่นด้วย tab) ชั้นเช่น 3/6

แก้ไขไฟล์ register.class.php บรรทัดที่ 471-473 ให้ลบออกเพื่อนำเข้าข้อมูลทั้งหมด (ปกติตั้งไว้เฉพาะ ม. 3) และบรรทัดที่ 481 ให้ปรับ `"year"` เป็นเลขรุ่นของชั้นที่นำเข้า

สั่งนำเข้าข้อมูลได้ที่ `http://localhost/register/@import2` (ต้อง login ก่อน)

## นำเข้า/ส่งออก

ทุกจุดต้อง Login ก่อน

### /register/@import

นำเข้าข้อมูลจาก data.csv (อ่านในหัวข้อ เตรียมไฟล์ data.csv)

>6,1,1,12345,นาย,สมชาย,นามสมมุติ,03072555,1111111111113,ชาย

### /register/@import2

นำเข้าข้อมูลจาก new.csv (อ่านวิธีใช้ในหัวข้อ รับข้อมูลม. 3 ของ Address module)

>no stuid prefix name surname class

### /register/@importfac

นำเข้าข้อมูลคณะจาก faculty.json (มีให้ในโค้ดโปรแกรม)

>[{"university": "uni", "name": "faculty"}, ...]

### /register/@importedz

นำเข้าข้อมูลศึกษาต่อจาก adm56.tsv (ขอข้อมูลจาก eduzones.com) โดยนำผลการค้นหาที่เป็นตารางที่ให้มาคัดลอกลงโปรแกรมแก้ไขข้อความใดๆ จะได้เป็นข้อมูลที่คั่นด้วย tab ตามรูปแบบ

>index  admId name  fac

โปรแกรมจะนำเข้าข้อมูลเฉพาะคนที่ไม่เคยกรอกข้อมูลเองเลย และข้อมูลที่กรอกครั้งล่าสุดเก่ากว่าวันที่ 2013-05-01 07:00:00 (แก้ไขที่บรรทัด 507)

### /register/@export

ส่งออกข้อมูลที่อยู่ในรูปแบบ csv

>class,no,prefix,name,surname,nick,birthday,address,telmobile,twitter,facebook,email,msn,line,innewformat

- **innewformat:** ข้อมูลนี้เก็บด้วยระบบมอดูล address จะมีค่าเป็น true
- **twitter,facebook,email,msn,line:** ระบบเก็บที่อยู่รุ่นปัจจุบันไม่มีการเก็บข้อมูลเหล่านี้แล้ว แต่ยังแสดงไว้สำหรับข้อมูลเก่า

### /register/@export2

ส่งออกข้อมูลการศึกษาต่อในรูปแบบ csv

>stuid,prefix,name,surname,class,uni,fac,filler,otherCnt

- **filler:** self ถ้ากรอกเอง, เลขประจำตัวนักเรียนของผู้กรอกถ้าเป็นคนอื่น, adm ถ้าใช้ระบบ importedz
- **otherCnt:** จำนวนครั้งที่กรอกข้อมูล (ไม่นับครั้งล่าสุด)

### /register/@exportnames

ส่งออกรายชื่อนักเรียนเป็น xls สำหรับการขอข้อมูลจาก eduzones

http://ez.eduzones.com/admissions56_result/admis51_result_school.php

## Caching

โปรแกรมส่ง caching header 10 นาทีในหน้าหลักๆ สามารถใช้ caching proxy เช่น nginx เพื่อลดโหลดของโปรแกรมเมื่อมีนักเรียนใช้จำนวนมากได้

## License

โปรแกรมเก็บข้อมูลฯ สงวนลิขสิทธิ์ 2555-2556 มนัสวิน หาญมงคลชัย

ท่านสามารถใช้งานโปรแกรมนี้ได้ภายใต้สัญญาอนุญาต GNU Affero General Public License รุ่นที่ 3
หรือใหม่กว่า

สามารถอ่านเนื้อหาของสัญญาอนุญาตได้ที่ http://www.gnu.org/licenses/agpl.html

บางส่วนของโปรแกรมมาจาก menome engine สงวนลิขสิทธิ์ 2554-2556 มนัสวิน หาญมงคลชัย

ท่านสามารถใช้งาน menome engine (จะมีการระบุที่หัวไฟล์ว่าไฟล์นี้อยู่ในแพคเกจใด) ได้ภายใต้สัญญาอนุญาต
StealItPL 1.0 หรือ AGPLv3 หรือใหม่กว่า

ข้อมูลคณะ (faculty.json) ใช้ข้อมูลจาก สอท. พร้อมข้อมูลแก้ไขเพิ่มเติม ไม่สงวนลิขสิทธิ์

### AGPLv3

ข้อสรุปนี้เป็นคำแนะนำ และไม่ใช่สัญญาอนุญาต กรุณาอ่านและตรวจสอบสัญญาอนุญาตฉบับเต็มก่อน

http://www.tldrlegal.com/license/gnu-affero-general-public-license-v3-(agpl-3.0)

**ทำได้**

- นำไปต่อยอดแสวงหาผลประโยชน์ในเชิงพาณิชย์
- แก้ไขดัดแปลงโปรแกรม
- แจกจ่าย เผยแพร่โปรแกรม

**ห้าม**

- ห้ามลบสัญญาอนุญาตและคำประกาศลิขสิทธิ์ต้นฉบับ
- โปรแกรมนี้ไม่มีการรับประกันใดๆ ไม่สามารถเรียกร้องการชดเชยความเสียหายใดๆ จากผู้พัฒนาได้

**ต้องทำ**

- ระบุสัญญาอนุญาตและคำประกาศลิขสิทธิ์ต้นฉบับไว้
- ระบุการเปลี่ยนแปลงต่อตัวโปรแกรม
- เผยแพร่ซอร์สโค้ดโปรแกรมเมื่อมีการดัดแปลง
- ผู้ใช้งานที่สามารถเข้าถึงโปรแกรมในช่องทางใดๆ รวมถึงทางเครือข่าย จะต้องสามารถขอรับซอร์สโค้ดของโปรแกรมได้เสมอ

### StealItPL 1.0

ข้อสรุปนี้เป็นคำแนะนำ และไม่ใช่สัญญาอนุญาต กรุณาอ่านและตรวจสอบสัญญาอนุญาตฉบับเต็มก่อน

https://raw.github.com/whs/whs.github.com/master/LICENSE

**ทำได้:**

- แก้ไขดัดแปลงโปรแกรม
- แจกจ่าย เผยแพร่โปรแกรม
- ไม่เปิดเผยต้นฉบับของโปรแกรม

**ห้าม**

- โปรแกรมที่นำไปเผยแพร่ ใช้งาน ดัดแปลง หรืออื่นใดจะต้องมีผู้ใช้งานไม่ถึง 100 คน (ผู้ใช้งานนับจากผู้ที่เคยเข้าถึงหรือใช้งานโปรแกรมในรอบ 1 เดือน ไม่ว่าสมัครสมาชิกหรือไม่)
- นำไปใช้งานในเชิงพาณิชย์

**ต้องทำ**

- หากดัดแปลงโปรแกรมจะต้องใช้สัญญาอนุญาตนี้เสมอ